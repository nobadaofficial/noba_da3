generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String          @id @default(cuid())
  clerkId       String          @unique
  email         String?         @unique
  username      String?
  profileImage  String?

  hearts        Int             @default(100)
  diamonds      Int             @default(10)

  sessions      ChatSession[]
  purchases     Purchase[]
  achievements  UserAchievement[]
  gallery       UserGalleryItem[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model Admin {
  id            String          @id @default(cuid())
  email         String          @unique
  passwordHash  String
  name          String

  role          AdminRole       @default(ADMIN)
  isActive      Boolean         @default(true)

  lastLoginAt   DateTime?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([email])
}

model Character {
  id            String          @id @default(cuid())
  name          String
  age           Int
  occupation    String
  description   String          @db.Text
  profileImage  String
  thumbnailUrl  String
  previewVideoUrl String?       // 숏폼 프리뷰 영상 URL

  personality   Json            // PersonalityTraits
  backstory     String          @db.Text
  voiceId       String          // TTS 음성 ID

  tags          String[]        // ["로맨틱", "일상", "힐링"]

  // Stats
  likeCount     Int             @default(0)
  chatCount     Int             @default(0)
  rating        Float           @default(4.5)

  isNew         Boolean         @default(true)
  isTrending    Boolean         @default(false)
  isPublished   Boolean         @default(false)

  episodes      Episode[]
  videoClips    VideoClip[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([isPublished])
  @@index([isTrending])
}

model Episode {
  id                String          @id @default(cuid())
  title             String
  description       String          @db.Text

  characterId       String
  character         Character       @relation(fields: [characterId], references: [id])

  category          Category
  difficulty        Difficulty

  introVideoUrl     String
  videoPoolIds      String[]        // 영상 풀 ID 목록

  baseStory         String          @db.Text
  branchPoints      Json            // BranchPoint[]

  playCount         Int             @default(0)
  avgRating         Float?

  sessions          ChatSession[]
  gallery           GalleryItem[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([category])
  @@index([difficulty])
  @@index([characterId])
}

model ChatSession {
  id                String          @id @default(cuid())

  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  episodeId         String
  episode           Episode         @relation(fields: [episodeId], references: [id])

  messages          Json            @default("[]") // Message[]
  relationshipScore Int             @default(0)
  emotionalState    Json            // EmotionState
  storyProgress     Int             @default(0)

  unlockedGallery   String[]
  currentBranch     String?

  status            SessionStatus   @default(ACTIVE)

  createdAt         DateTime        @default(now())
  lastPlayedAt      DateTime        @default(now())
  completedAt       DateTime?

  @@index([userId])
  @@index([episodeId])
  @@index([status])
  @@index([userId, status])
  @@index([userId, episodeId, status])
}

model VideoClip {
  id            String          @id @default(cuid())
  url           String          // GCS URL
  thumbnailUrl  String

  emotion       String          // EmotionType
  intensity     Int             // 1-3
  tags          String[]
  duration      Int             // seconds

  characterId   String?
  character     Character?      @relation(fields: [characterId], references: [id])

  createdAt     DateTime        @default(now())

  @@index([emotion])
  @@index([characterId])
}

model TTSCache {
  id            String          @id @default(cuid())
  textHash      String          @unique

  text          String          @db.Text
  voiceId       String
  emotion       String

  audioUrl      String          // GCS URL
  duration      Int             // milliseconds

  usageCount    Int             @default(1)
  lastUsedAt    DateTime        @default(now())
  createdAt     DateTime        @default(now())

  @@index([textHash])
  @@index([lastUsedAt])
}

model Purchase {
  id            String          @id @default(cuid())
  userId        String
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  type          PurchaseType
  amount        Int             // 구매 수량
  price         Int             // 가격 (원)
  currency      String          @default("KRW")

  status        PaymentStatus   @default(PENDING)

  // Payment Gateway Info
  transactionId String?         @unique
  paymentMethod String?

  createdAt     DateTime        @default(now())
  completedAt   DateTime?

  @@index([userId])
  @@index([status])
  @@index([transactionId])
}

model GalleryItem {
  id                String          @id @default(cuid())
  episodeId         String
  episode           Episode         @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  type              GalleryItemType
  title             String
  url               String          // GCS URL
  thumbnailUrl      String

  unlockCondition   String
  relationshipReq   Int?            // 필요 관계도
  diamondCost       Int?            // 다이아 비용

  userItems         UserGalleryItem[]

  createdAt         DateTime        @default(now())

  @@index([episodeId])
}

model UserGalleryItem {
  id            String          @id @default(cuid())
  userId        String
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  galleryItemId String
  galleryItem   GalleryItem     @relation(fields: [galleryItemId], references: [id], onDelete: Cascade)

  unlockedAt    DateTime        @default(now())

  @@unique([userId, galleryItemId])
  @@index([userId])
}

model Achievement {
  id            String          @id @default(cuid())
  code          String          @unique
  title         String
  description   String
  icon          String

  category      AchievementCategory
  maxProgress   Int             @default(1)

  reward        Json?           // { hearts?: number, diamonds?: number }

  userAchievements UserAchievement[]

  createdAt     DateTime        @default(now())

  @@index([category])
}

model UserAchievement {
  id            String          @id @default(cuid())
  userId        String
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  achievementId String
  achievement   Achievement     @relation(fields: [achievementId], references: [id])

  progress      Int             @default(0)
  completed     Boolean         @default(false)
  completedAt   DateTime?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([completed])
}

// Enums
enum Category {
  FIRST_LOVE
  OFFICE
  FANTASY
  DAILY
  MYSTERY
}

enum Difficulty {
  EASY
  NORMAL
  HARD
}

enum SessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

enum PurchaseType {
  HEARTS
  DIAMONDS
  SUBSCRIPTION
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum GalleryItemType {
  IMAGE
  VIDEO
}

enum AchievementCategory {
  ROMANCE
  COLLECTION
  EXPLORATION
  SOCIAL
  SPECIAL
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  EDITOR
}